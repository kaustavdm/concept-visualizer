# PWA Implementation Plan

> **For Claude:** REQUIRED SUB-SKILL: Use superpowers:executing-plans to implement this plan task-by-task.

**Goal:** Make Concept Visualizer installable and offline-first, and fix the hardcoded hostname in the settings CORS warning.

**Architecture:** `vite-plugin-pwa` with Workbox `generateSW` mode auto-precaches all build assets. Runtime strategies handle Google Fonts and the TF.js model. A hand-crafted SVG icon provides the visual identity.

**Tech Stack:** vite-plugin-pwa, Workbox (bundled in plugin), SVG

---

### Task 1: Fix hardcoded hostname in settings warning

**Files:**
- Modify: `src/routes/settings/+page.svelte`

**Step 1: Edit the warning text**

In `src/routes/settings/+page.svelte`, change the single line that reads:

```svelte
<li>Use <strong>Chrome</strong> and set <code>OLLAMA_ORIGINS=https://conceptviz.vercel.app</code></li>
```

to:

```svelte
<li>Use <strong>Chrome</strong> and set <code>OLLAMA_ORIGINS={typeof window !== 'undefined' ? window.location.origin : 'https://your-app-origin'}</code></li>
```

**Step 2: Verify**

Run `npm run dev`, open Settings, type `http://localhost:11434/v1` in the endpoint field. The warning should show `OLLAMA_ORIGINS=http://localhost:5173` (or wherever dev runs).

**Step 3: Commit**

```bash
git add src/routes/settings/+page.svelte
git commit -m "fix: use window.location.origin in CORS warning instead of hardcoded hostname"
```

---

### Task 2: Create SVG icons

**Files:**
- Create: `static/favicon.svg`
- Create: `static/icon.svg`

**Step 1: Create `static/favicon.svg`**

A three-node graph on a blue rounded-square background:

```svg
<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512">
  <rect width="512" height="512" rx="112" fill="#3b82f6"/>
  <line x1="256" y1="168" x2="152" y2="336" stroke="white" stroke-width="28" stroke-linecap="round" opacity="0.55"/>
  <line x1="256" y1="168" x2="360" y2="336" stroke="white" stroke-width="28" stroke-linecap="round" opacity="0.55"/>
  <line x1="152" y1="336" x2="360" y2="336" stroke="white" stroke-width="28" stroke-linecap="round" opacity="0.55"/>
  <circle cx="256" cy="168" r="52" fill="white"/>
  <circle cx="152" cy="336" r="40" fill="white" opacity="0.9"/>
  <circle cx="360" cy="336" r="40" fill="white" opacity="0.9"/>
</svg>
```

**Step 2: Create `static/icon.svg`**

Same icon but full-bleed (no rounded corners) with extra padding so content sits in the maskable safe area (inner 80% of canvas):

```svg
<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512">
  <rect width="512" height="512" fill="#3b82f6"/>
  <line x1="256" y1="188" x2="172" y2="324" stroke="white" stroke-width="24" stroke-linecap="round" opacity="0.55"/>
  <line x1="256" y1="188" x2="340" y2="324" stroke="white" stroke-width="24" stroke-linecap="round" opacity="0.55"/>
  <line x1="172" y1="324" x2="340" y2="324" stroke="white" stroke-width="24" stroke-linecap="round" opacity="0.55"/>
  <circle cx="256" cy="188" r="44" fill="white"/>
  <circle cx="172" cy="324" r="34" fill="white" opacity="0.9"/>
  <circle cx="340" cy="324" r="34" fill="white" opacity="0.9"/>
</svg>
```

**Step 3: Update `src/app.html` favicon link**

Change:
```html
<link rel="icon" href="%sveltekit.assets%/favicon.png" />
```
to:
```html
<link rel="icon" href="%sveltekit.assets%/favicon.svg" type="image/svg+xml" />
```

**Step 4: Commit**

```bash
git add static/favicon.svg static/icon.svg src/app.html
git commit -m "feat: add SVG icons for PWA and favicon"
```

---

### Task 3: Update app.html — title and meta

**Files:**
- Modify: `src/app.html`

**Step 1: Add title, description, and theme-color**

In `src/app.html`, inside `<head>`, add after the viewport meta:

```html
<title>Concept Visualizer</title>
<meta name="description" content="Extract and visualize concepts and relationships from text using LLM, NLP, or local AI." />
<meta name="theme-color" content="#3b82f6" />
```

**Step 2: Verify**

Run `npm run dev`, check browser tab shows "Concept Visualizer".

**Step 3: Commit**

```bash
git add src/app.html
git commit -m "feat: add page title, description, and theme-color meta"
```

---

### Task 4: Install and configure vite-plugin-pwa

**Files:**
- Modify: `vite.config.ts`
- Auto-generated by plugin: `build/manifest.webmanifest`, `build/sw.js`, `build/workbox-*.js`

**Step 1: Install the package**

```bash
npm install -D vite-plugin-pwa
```

Expected: package added to `devDependencies` in `package.json`.

**Step 2: Update `vite.config.ts`**

Replace entire file content with:

```ts
import { defineConfig } from 'vite';
import { sveltekit } from '@sveltejs/kit/vite';
import tailwindcss from '@tailwindcss/vite';
import { VitePWA } from 'vite-plugin-pwa';

export default defineConfig({
  plugins: [
    tailwindcss(),
    sveltekit(),
    VitePWA({
      registerType: 'autoUpdate',
      includeAssets: ['favicon.svg', 'icon.svg'],
      manifest: {
        name: 'Concept Visualizer',
        short_name: 'ConceptViz',
        description: 'Extract and visualize concepts and relationships from text.',
        theme_color: '#3b82f6',
        background_color: '#f9fafb',
        display: 'standalone',
        icons: [
          { src: 'favicon.svg', sizes: 'any', type: 'image/svg+xml' },
          { src: 'icon.svg', sizes: 'any', type: 'image/svg+xml', purpose: 'maskable' }
        ]
      },
      workbox: {
        globPatterns: ['**/*.{js,css,html,svg,woff2}'],
        runtimeCaching: [
          {
            urlPattern: /^https:\/\/fonts\.googleapis\.com\/.*/i,
            handler: 'StaleWhileRevalidate',
            options: {
              cacheName: 'google-fonts-stylesheet',
              expiration: { maxEntries: 4, maxAgeSeconds: 60 * 60 * 24 * 365 }
            }
          },
          {
            urlPattern: /^https:\/\/fonts\.gstatic\.com\/.*/i,
            handler: 'CacheFirst',
            options: {
              cacheName: 'google-fonts-files',
              expiration: { maxEntries: 8, maxAgeSeconds: 60 * 60 * 24 * 365 },
              cacheableResponse: { statuses: [0, 200] }
            }
          },
          {
            urlPattern: /^https:\/\/(storage\.googleapis\.com|tfhub\.dev)\/.*/i,
            handler: 'CacheFirst',
            options: {
              cacheName: 'tfjs-model',
              expiration: { maxEntries: 5, maxAgeSeconds: 60 * 60 * 24 * 30 },
              cacheableResponse: { statuses: [0, 200] }
            }
          }
        ]
      }
    })
  ],
  build: {
    chunkSizeWarningLimit: 2000
  },
  test: {
    include: ['src/**/*.test.ts'],
    setupFiles: ['vitest.setup.ts'],
    environment: 'jsdom'
  }
});
```

**Step 3: Verify build succeeds**

```bash
npm run build
```

Expected output includes: `PWA v?.?.? | mode generateSW` lines and no errors. Build output in `.svelte-kit/output/` (static adapter then copies to `build/`).

**Step 4: Verify PWA works in preview**

```bash
npm run preview
```

Open `http://localhost:4173` in Chrome. Open DevTools → Application → Service Workers — should show a SW registered. Application → Manifest — should show Concept Visualizer with icons.

**Step 5: Run tests to confirm nothing broke**

```bash
npx vitest run
```

Expected: all existing tests pass (the plugin change is build-only, no runtime test impact).

**Step 6: Commit**

```bash
git add vite.config.ts package.json package-lock.json
git commit -m "feat: add offline-first PWA with vite-plugin-pwa and Workbox"
```
